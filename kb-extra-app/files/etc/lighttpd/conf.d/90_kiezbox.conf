# Kiezbox specific lighttpd configuration

server.modules += ( "mod_setenv" )
server.modules += ( "mod_access" )
server.modules += ( "mod_cgi" )
server.modules += ( "mod_auth", "mod_authn_file" )

# dynamic parts are generated by a script
# to allow for centralized configuration via uci
include_shell "/opt/kb-script/lighttpd_config.sh"

$SERVER["socket"] == ":443" {
    ssl.engine = "enable"
    ssl.pemfile = "/opt/kb-certs/fullchain.pem"
    ssl.privkey = "/opt/kb-certs/privkey.pem"
    # server the main application
    server.document-root = "/opt/kb-www/"
    #TODO: check why cache is still used on some platforms
    setenv.add-response-header = (
      "Cache-Control" => "no-cache, no-store, must-revalidate",
      "Pragma" => "no-cache",
      "Expires" => "0"
    )
    server.max-read-idle = 300
    # accesslog.filename = "/tmp/lighttpd.log"
    # captive portal (API) specific setup
    ## redirect request for other hosts to the captive portal
    $HTTP["host"] != kb-domain {
        url.redirect-code = 302
        url.redirect = ( "" => "https://" + kb-domain + "/" )
    }
    ## redirect captive portal API request to the cgi script
    $HTTP["url"] =~ "^/captive-portal/api/" {
        alias.url += ( "/captive-portal/api" => "/opt/kb-script" )
        url.rewrite-once = ( "^/captive-portal/api" => "/captive-portal/api/portal_api_cgi.sh" )
        cgi.assign = ( "" => "" )
    }
    ## server captive portal from correct directory
    alias.url += ( "/captive-portal" => "/opt/kb-portal" )
    ## http digest auth config
    auth.backend = "htdigest"
    auth.backend.htdigest.userfile = "/etc/lighttpd/htdigest.user"
    ## Auth for admin ui and API
    auth.require = ( "/admin" =>
          (
            "method"    => "digest",
            "algorithm" => "SHA-256",
            "realm"     => "admin",
            "require"   => "valid-user"
          ),
          "/api/admin" =>
          (
            "method"    => "digest",
            "algorithm" => "SHA-256",
            "realm"     => "admin",
            "require"   => "valid-user"
          )
        )
    ## serve captive portal from correct directory
    alias.url += ( "/admin" => "/opt/kb-admin" )
    # gateway service API  proxy setup
    $HTTP["url"] =~ "^/api/asterisk.*" {
        url.access-deny = ("")
    }
    ## remove /api prefix for backend
    proxy.header = (
        "map-urlpath" => ( "/api/" => "/" ),
        "upgrade" => "enable"
    )
    proxy.server = (
        "/api/" => (
            "gatewayapi" => (
                "host" => "localhost",
                "port" => 9080,
            )
        ),
        "/ws" => (
            "asteriskws" => (
                "host" => "localhost",
                "port" => 8088,
            )
        )
   )
}

